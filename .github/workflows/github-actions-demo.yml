name: Check RSAT matrix-clustering demos
on:
  push:

jobs:
  check-demos:
    runs-on: ubuntu-24.04
    steps:
    
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Install non-R dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ libcurl4-openssl-dev libssl-dev libxml2-dev libharfbuzz-dev libfontconfig1-dev libfribidi-dev
    
      # Step 3: Set up R
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4.0'

      - name: Set RENV_PATHS_ROOT
        shell: bash
        run: |
         echo "RENV_PATHS_ROOT=${{ runner.temp }}/renv" >> $GITHUB_ENV

      # Step 4: Install renv
      - name: Install renv
        run: |
          install.packages(c('renv', 'svglite'))
          renv::activate()
        shell: Rscript {0} 
          
  
      - name: Get R and OS version
        id: get-version
        run: |
          cat("##[set-output name=os-version;]", sessionInfo()$running, "\n", sep = "")
          cat("##[set-output name=r-version;]", R.Version()$version.string, sep = "")
        shell: Rscript {0}
  
      - name: Restore Renv package cache
        uses: actions/cache@v4
        with:
          path: ${{ env.RENV_PATHS_ROOT }}
          key: ${{ steps.get-version.outputs.os-version }}-${{ steps.get-version.outputs.r-version }}-${{ inputs.cache-version }}-${{ hashFiles('renv.lock') }}
          restore-keys: ${{ steps.get-version.outputs.os-version }}-${{ steps.get-version.outputs.r-version }}-${{inputs.cache-version }}-



      # # Step 5: Cache renv packages
      # - name: Cache R packages
      #   uses: actions/cache@v4
      #   with:
      #     path: renv/library
      #     key: ${{ runner.os }}-renv-${{ hashFiles('renv.lock') }}-${{ matrix.config.platform }}
      #     restore-keys: |
      #       ${{ runner.os }}-renv-${{ matrix.config.platform }}
      #       ${{ runner.os }}-renv-
      # 
      # # Step 6: Restore R environment using renv
      # - name: Restore R environment
      #   run: Rscript -e "renv::restore()"

      # Step 7: Compile compare-matrices-quick
      - name: Compile compare-matrices
        run: |
          cd compare-matrices-quick
          make
          cd ..

      # --------- #
      # Run demos #
      # --------- #
      - name: Run Clustering Demo 1
        run: |
          Rscript matrix-clustering.R \
          -i data/OCT4_datasets/OCT4_motif_table.txt \
          -o results/OCT4_motifs_clusters/OCT4_motif_analysis \
          -w 1
          
      - name: Run Clustering Demo 2
        run: |
          Rscript matrix-clustering.R                         \
          -i data/JASPAR_2022/Jaspar_nematodes_motifs_tab.txt \
          -o results/JASPAR_nematodes_radial/JASPAR_nematodes \
          -a data/JASPAR_2022/JASPAR_nematodes_metadata.txt   \
          --radial_tree TRUE                                  \
          --title JASPAR_CORE_nematodes                       \
          -w 1

      
      # Each demo with 1 and >1 motifs
      # Demos for Logo
      # Demos for Format conversion
      # Demos for Trim
